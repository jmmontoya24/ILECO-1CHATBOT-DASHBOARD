<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PowerGrid Complaint Management Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
    <meta http-equiv="refresh" content="30">
    
    <style>
        /* Base Styles */
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            background: #f9f9f9;
        }

        /* Alert Bar */
        .alert-bar {
            background: #e74c3c;
            color: #fff;
            padding: 8px;
            text-align: center;
            font-weight: bold;
        }

        /* Header */
        .header {
            background: #003366;
            color: white;
            padding: 20px;
            text-align: center;
        }
        
        .header h1 {
            margin: 0;
            font-size: 24px;
        }

        /* Dashboard Layout */
        .dashboard {
            display: grid;
            grid-template-columns: 75% 25%;
            gap: 20px;
            padding: 20px;
        }

        /* Map Section */
        .map-section {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            overflow: hidden;
            margin-bottom: 20px;
        }

        #map {
            height: 500px;
            width: 100%;
        }

        .map-controls {
            padding: 15px;
            background: #f8f9fa;
            border-top: 1px solid #dee2e6;
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .map-controls input {
            flex: 1;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .map-controls button {
            padding: 8px 16px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        .map-controls button:hover {
            background: #0056b3;
        }

        /* Statistics Grid */
        .stats-grid {
            display: flex;
            justify-content: space-between;
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            flex: 1;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .stat-number {
            font-size: 36px;
            font-weight: bold;
            margin-bottom: 8px;
        }

        .stat-number.urgent { color: #dc3545; }
        .stat-number.warning { color: #ffc107; }
        .stat-number.success { color: #28a745; }
        .stat-number.info { color: #17a2b8; }

        .stat-label {
            font-size: 14px;
            color: #6c757d;
            font-weight: 500;
        }

        /* Section Headers */
        .section-header {
            background: white;
            padding: 15px 20px;
            border-radius: 8px 8px 0 0;
            font-size: 16px;
            font-weight: bold;
            color: #495057;
            border-bottom: 1px solid #dee2e6;
        }

        /* Filters */
        .filters {
            display: flex;
            gap: 15px;
            align-items: end;
            flex-wrap: wrap;
            width: 100%;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            min-width: 120px;
        }

        .filter-group label {
            font-size: 12px;
            font-weight: 600;
            color: #495057;
            margin-bottom: 3px;
        }

        .filter-group select,
        .filter-group input[type="text"] {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 13px;
            background: white;
        }

        .filter-group input[type="text"]:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 2px rgba(0,123,255,.25);
        }

        /* Date Filter Styles */
        .date-filter-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .date-filter-group label {
            font-size: 12px;
            font-weight: 600;
            color: #495057;
            margin-bottom: 2px;
        }
        
        .date-inputs {
            display: flex;
            gap: 8px;
            align-items: center;
        }
        
        .date-inputs input[type="date"], 
        .date-inputs input[type="time"] {
            padding: 6px 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 12px;
            background: white;
        }
        
        .date-inputs input[type="date"]:focus, 
        .date-inputs input[type="time"]:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 2px rgba(0,123,255,.25);
        }
        
        .date-separator {
            font-size: 12px;
            color: #666;
            font-weight: 500;
        }

        /* Quick Filters */
        .quick-filters {
            display: flex;
            gap: 5px;
            margin-top: 5px;
            flex-wrap: wrap;
        }
        
        .quick-filter-btn {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 3px 8px;
            font-size: 10px;
            border-radius: 3px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .quick-filter-btn:hover {
            background: #e9ecef;
            border-color: #adb5bd;
        }
        
        .quick-filter-btn.active {
            background: #007bff;
            color: white;
            border-color: #007bff;
        }

        /* Buttons */
        .btn-search, .btn-clear {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: background-color 0.2s;
        }
        
        .btn-search {
            background: #007bff;
            color: white;
        }
        
        .btn-search:hover {
            background: #0056b3;
        }
        
        .btn-clear {
            background: #6c757d;
            color: white;
        }
        
        .btn-clear:hover {
            background: #545b62;
        }

        /* Popup Styles */
        .location-popup {
            min-width: 250px;
        }

        .location-popup h4 {
            margin: 0 0 10px 0;
            color: #003366;
        }

        .location-popup p {
            margin: 5px 0;
            font-size: 13px;
        }

        .popup-status {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            margin-top: 5px;
            text-transform: uppercase;
        }

        .popup-status.pending, .popup-status.new {
            background: #fff3cd;
            color: #856404;
        }

        .popup-status.resolved {
            background: #d4edda;
            color: #155724;
        }

        .popup-status.in_progress, .popup-status.assigned {
            background: #d1ecf1;
            color: #0c5460;
        }

        /* Table Styles */
        .complaints-section {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .table-container {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }

        th, td {
            padding: 12px 10px;
            border-bottom: 1px solid #dee2e6;
            text-align: left;
            font-size: 13px;
        }

        th {
            background: #f8f9fa;
            font-weight: 600;
            color: #495057;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .no-data {
            text-align: center;
            color: #6c757d;
            font-style: italic;
            padding: 40px;
        }

        /* Badges */
        .priority-badge, .status-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .priority-critical {
            background: #b71c1c;
            color: #fff;
            font-weight: bold;
            text-transform: uppercase;
            box-shadow: 0 0 8px rgba(183, 28, 28, 0.6);
            animation: pulse 1.5s infinite;
        }

        .priority-low { background: #d4edda; color: #155724; }
        .priority-medium { background: #fff3cd; color: #856404; }
        .priority-high { background: #f8d7da; color: #721c24; }
        .priority-none { background: #e9ecef; color: #6c757d; }

        .status-new { background: #cce5ff; color: #004085; }
        .status-assigned { background: #fff3cd; color: #856404; }
        .status-in_progress { background: #d1ecf1; color: #0c5460; }
        .status-resolved { background: #d4edda; color: #155724; }
        .status-none { background: #e9ecef; color: #6c757d; }

        /* Action Buttons */
        .actions {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
            font-weight: 500;
            text-decoration: none;
            display: inline-block;
            transition: all 0.2s;
        }

        .btn-primary { background: #007bff; color: white; }
        .btn-primary:hover { background: #0056b3; }
        .btn-danger { background: #dc3545; color: white; }
        .btn-danger:hover { background: #c82333; }
        .btn-success { background: #28a745; color: white; }
        .btn-success:hover { background: #1e7e34; }
        .btn-warning { background: #ffc107; color: #212529; }
        .btn-warning:hover { background: #e0a800; }

        /* Layout */
        .main-content {
            display: flex;
            gap: 20px;
            margin-top: 20px;
        }

        .sidebar {
            flex: 1;
            max-width: 300px;
        }

        .complaints-section {
            flex: 3;
        }

        .analytics {
            flex: 1;
            max-width: 300px;
        }

        /* Right Sidebar */
        .right-side {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        /* Agent Queue */
        .agent-queue {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .scroll-container {
            max-height: 400px;
            overflow-y: auto;
            padding: 15px;
        }

        .queue-card {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            border-left: 4px solid #007bff;
        }

        .queue-card h3 {
            margin: 0 0 10px 0;
            font-size: 14px;
            color: #495057;
        }

        .queue-body p {
            margin: 5px 0;
            font-size: 12px;
            color: #6c757d;
        }

        .badge {
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 10px;
            font-weight: 600;
        }

        .badge.low { background: #d4edda; color: #155724; }
        .badge.medium { background: #fff3cd; color: #856404; }
        .badge.high { background: #f8d7da; color: #721c24; }
        .badge.priority-none { background: #e9ecef; color: #6c757d; }

        .resume-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            width: 100%;
            margin-top: 10px;
        }

        .resume-btn:hover {
            background: #1e7e34;
        }

        /* Analytics */
        .analytics {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .analytics-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            padding: 15px;
        }

        .analytics-card {
            text-align: center;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .analytics-number {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .analytics-label {
            font-size: 11px;
            color: #6c757d;
            font-weight: 500;
        }

        .chart-container {
            padding: 15px;
            height: 250px;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1050;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow-y: auto;
            background: rgba(0, 0, 0, 0.6);
            animation: fadeIn 0.3s ease-in-out;
        }

        .modal-dialog {
            max-width: 800px;
            margin: 1.75rem auto;
        }

        .modal-content {
            background: #fff;
            margin: 5% auto;
            padding: 25px 30px;
            border-radius: 12px;
            width: 500px;
            max-width: 90%;
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
            animation: slideIn 0.4s ease;
        }
        
        .modal-content h2 {
            margin-top: 0;
            font-size: 20px;
            font-weight: 600;
            border-bottom: 2px solid #eee;
            padding-bottom: 10px;
            color: #2c3e50;
        }

        .modal-header {
            padding: 15px;
            border-bottom: 1px solid #dee2e6;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-body {
            padding: 20px;
            max-height: 400px;
            overflow-y: auto;
        }

        .modal-footer {
            padding: 15px;
            border-top: 1px solid #dee2e6;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .left-side {
            flex: 3;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .btn-close {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: #6c757d;
        }

        .btn-close:hover {
            color: #495057;
        }

        /* Notification */
        .notification {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #28a745;
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            display: none;
            z-index: 1001;
        }

        .notification.show {
            display: block;
            animation: slideIn 0.3s ease;
        }
        
        .close {
            float: right;
            font-size: 24px;
            font-weight: bold;
            color: #aaa;
            cursor: pointer;
        }

        .close:hover {
            color: #e74c3c;
        }
        
        #complaint-details {
            margin-top: 15px;
        }

        #complaint-details table {
            width: 100%;
            border-collapse: collapse;
        }
        
        #complaint-details th,
        #complaint-details td {
            text-align: left;
            padding: 8px 10px;
            border-bottom: 1px solid #f0f0f0;
        }

        #complaint-details th {
            width: 35%;
            font-weight: 600;
            color: #34495e;
        }
        
        #complaint-details td {
            color: #555;
        }
        
        /* Animations */
        @keyframes fadeIn {
            from {opacity: 0;}
            to {opacity: 1;}
        }

        @keyframes slideIn {
            from {transform: translateY(-20px); opacity: 0;}      
            to {transform: translateY(0); opacity: 1;}
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 6px rgba(183,28,28,0.6); }
            50% { box-shadow: 0 0 14px rgba(183,28,28,1); }
            100% { box-shadow: 0 0 6px rgba(183,28,28,0.6); }
        }

        /* Map Legend */
        .map-legend {
            background: white;
            padding: 10px;
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
            font-size: 12px;
        }

        .legend-icon {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .legend-icon.critical { background: #b71c1c; }
        .legend-icon.high { background: #f44336; }
        .legend-icon.medium { background: #ff9800; }
        .legend-icon.low { background: #4caf50; }
        .legend-icon.resolved { background: #2196f3; }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 8px;
            margin: 20px;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .dashboard {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                flex-direction: column;
            }
            
            .filters {
                flex-direction: column;
                align-items: stretch;
            }
            
            .filter-group {
                min-width: auto;
            }
        }
    </style>
</head>

<body>
    <!-- Alert Bar -->
    <div class="alert-bar">
        ‚ö° OUTAGE ALERT: Scheduled maintenance in District 5 - Expected completion: 6:00 PM
    </div>

    <!-- Header -->
    <div class="header">
        <h1>‚ö° ILECO-1 Complaints Monitoring Dashboard</h1>
        <p>Real-time Customer Service Dashboard with Location Tracking</p>
    </div>

    <!-- Main Dashboard -->
    <div class="dashboard">
        <!-- Left Side - Main Content -->
        <div class="left-side">
            <!-- Statistics Grid -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number urgent" id="totalComplaints">{{ complaints|length if complaints else 0 }}</div>
                    <div class="stat-label">Total Active Complaints</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number warning" id="waitingQueue">{{ queue|length if queue else 0 }}</div>
                    <div class="stat-label">Waiting for Agent</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number success" id="resolvedToday">{{ resolved_today if resolved_today else 0 }}</div>
                    <div class="stat-label">Resolved Today</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number info" id="avgResponseTime">{{ avg_wait_minutes if avg_wait_minutes else 0 }}</div>
                    <div class="stat-label">Avg Response Time (min)</div>
                </div>
            </div>

            <!-- Map Section -->
            <div class="map-section">
                <div class="section-header">
                    üìç Complaints Location Map
                </div>
                <div id="map"></div>
                <div class="map-controls">
                    <input type="text" id="addressSearch" placeholder="Enter address to search...">
                    <button onclick="searchLocation()">Search</button>
                    <button onclick="refreshMapData()">Refresh Map</button>
                </div>
            </div>

            <!-- Complaints Section -->
            <div class="complaints-section">
                <div class="section-header">
                    üìã Recent Complaints & Agent Requests
                </div>
                
                <!-- Filters -->
                <div class="filters">
                    <form method="GET" id="filterForm" style="display: flex; gap: 15px; align-items: end; flex-wrap: wrap; width: 100%;">
                        <div class="filter-group">
                            <label for="search">Search Name/ID</label>
                            <input type="text" 
                                   name="search" 
                                   id="search" 
                                   value="{{ current_search if current_search else '' }}"
                                   placeholder="Enter name or customer ID"
                                   title="Search by name or customer ID">
                        </div>

                        <div class="filter-group">
                            <label for="status">Status</label>
                            <select name="status" id="status">
                                <option value="All Status" {{ 'selected' if current_status == 'All Status' else '' }}>All Status</option>
                                <option value="NEW" {{ 'selected' if current_status == 'NEW' else '' }}>New</option>
                                <option value="ASSIGNED" {{ 'selected' if current_status == 'ASSIGNED' else '' }}>Assigned</option>
                                <option value="IN_PROGRESS" {{ 'selected' if current_status == 'IN_PROGRESS' else '' }}>In Progress</option>
                                <option value="RESOLVED" {{ 'selected' if current_status == 'RESOLVED' else '' }}>Resolved</option>
                            </select>
                        </div>
                        
                        <div class="filter-group">
                            <label for="priority">Priority</label>
                            <select name="priority" id="priority">
                                <option value="All Priorities" {{ 'selected' if current_priority == 'All Priorities' else '' }}>All Priorities</option>
                                <option value="CRITICAL" {{ 'selected' if current_priority == 'CRITICAL' else '' }} style="background: #dc3545; color: white;">‚ö†Ô∏è Critical</option>
                                <option value="HIGH" {{ 'selected' if current_priority == 'HIGH' else '' }}>High</option>
                                <option value="MEDIUM" {{ 'selected' if current_priority == 'MEDIUM' else '' }}>Medium</option>
                                <option value="LOW" {{ 'selected' if current_priority == 'LOW' else '' }}>Low</option>
                            </select>
                        </div>

                        <div class="filter-group">
                            <label for="type">Type</label>
                            <select name="type" id="type">
                                <option value="All Types" {{ 'selected' if current_type == 'All Types' else '' }}>All Types</option>
                                <option value="Technical" {{ 'selected' if current_type == 'Technical' else '' }}>Technical</option>
                                <option value="Service" {{ 'selected' if current_type == 'Service' else '' }}>Service</option>
                                <option value="Billing" {{ 'selected' if current_type == 'Billing' else '' }}>Billing</option>
                                <option value="Power Outage" {{ 'selected' if current_type == 'Power Outage' else '' }}>Power Outage</option>
                            </select>
                        </div>

                        <div class="filter-group date-filter-group">
                            <label>üìÖ Date & Time Filter</label>
                            <div class="date-inputs">
                                <input type="date" 
                                       name="date_from" 
                                       id="date_from" 
                                       value="{{ current_date_from if current_date_from else '' }}"
                                       title="From Date">
                                <span class="date-separator">to</span>
                                <input type="date" 
                                       name="date_to" 
                                       id="date_to" 
                                       value="{{ current_date_to if current_date_to else '' }}"
                                       title="To Date">
                            </div>
                            <div class="date-inputs" style="margin-top: 3px;">
                                <input type="time" 
                                       name="time_from" 
                                       id="time_from" 
                                       value="{{ current_time_from if current_time_from else '' }}"
                                       title="From Time">
                                <span class="date-separator">to</span>
                                <input type="time" 
                                       name="time_to" 
                                       id="time_to" 
                                       value="{{ current_time_to if current_time_to else '' }}"
                                       title="To Time">
                            </div>
                            <div class="quick-filters">
                                <button type="button" class="quick-filter-btn" onclick="setQuickFilter('today')">Today</button>
                                <button type="button" class="quick-filter-btn" onclick="setQuickFilter('yesterday')">Yesterday</button>
                                <button type="button" class="quick-filter-btn" onclick="setQuickFilter('week')">This Week</button>
                                <button type="button" class="quick-filter-btn" onclick="setQuickFilter('month')">This Month</button>
                            </div>
                        </div>

                        <div class="filter-group" style="display: flex; gap: 8px; flex-direction: row; align-items: center;">
                            <button type="submit" class="btn-search">Filter</button>
                            <button type="button" class="btn-clear" onclick="clearAllFilters()">Clear All</button>
                        </div>
                    </form>
                </div>

                <!-- Complaints Table -->
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Complaint #</th>
                                <th>Time</th>
                                <th>Customer ID</th>
                                <th>Job Order ID</th>
                                <th>Issue Type</th>
                                <th>Description</th>
                                <th>Priority</th>
                                <th>Status</th>
                                <th>Source</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="complaintsTableBody">
                            {% if complaints %}
                                {% for complaint in complaints %}
                                <tr>
                                    <td>#{{ loop.index }}</td>
                                    <td>{{ complaint.time if complaint.time else 'N/A' }}</td>
                                    <td>{{ complaint.customer_id if complaint.customer_id else 'N/A' }}</td>
                                    <td>{{ complaint.job_order_id if complaint.job_order_id else 'N/A' }}</td>
                                    <td>{{ complaint.issue_type if complaint.issue_type else 'N/A' }}</td>
                                    </td>{{ complaint.description if complaint.description else 'No description' }}</td>
                                     <td>
                                        {% if complaint.priority %}
                                        <span class="priority-badge priority-{{ complaint.priority|lower }}">
                                            {{ complaint.priority }}
                                        </span>
                                        {% else %}
                                        <span class="priority-badge priority-none">N/A</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if complaint.status %}
                                        <span class="status-badge status-{{ complaint.status|lower }}">
                                            {{ complaint.status }}
                                        </span>
                                        {% else %}
                                        <span class="status-badge status-none">N/A</span>
                                        {% endif %}
                                    </td>
                                    <td>{{ complaint.source if complaint.source else 'N/A' }}</td>
                                    <td>
                                        <div class="actions">
                                            <button class="btn btn-primary btn-sm view-complaint"
                                                    data-table="{{ complaint.table }}"
                                                    data-id="{{ complaint.record_id }}">
                                                View
                                            </button>
                                            <button class="btn btn-danger btn-sm"
                                                    onclick="removeComplaint('{{ complaint.table }}', '{{ complaint.record_id }}')">
                                                Remove
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            {% else %}
                                <tr>
                                    <td colspan="10" class="no-data">No complaints found matching your criteria.</td>
                                </tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Right Side - Sidebar -->
        <div class="right-side">
            <!-- Agent Queue -->
            <div class="agent-queue">
                <div class="section-header">üë• Agent Assignment Queue</div>
                <div id="agentQueueList" class="scroll-container">
                    {% if queue %}
                        {% for row in queue %}
                            <div class="queue-card">
                                <h3>üßë‚Äçüíª Agent Assignment</h3>
                                <div class="queue-body">
                                    <p><strong>Name:</strong> {{ row[2] if row|length > 2 else 'N/A' }}</p>
                                    <p><strong>Concern:</strong> 
                                        {{ (row[3][:50] + '...') if row|length > 3 and row[3]|length > 50 else (row[3] if row|length > 3 else 'N/A') }}
                                    </p>
                                    <p><strong>Contact:</strong> {{ row[4] if row|length > 4 else 'N/A' }}</p>
                                    <p><strong>Priority:</strong>
                                        {% if row|length > 5 and row[5] %}
                                        <span class="badge {{ row[5]|lower }}">{{ row[5]|capitalize }}</span>
                                        {% else %}
                                        <span class="badge priority-none">N/A</span>
                                        {% endif %}
                                    </p>
                                    <p><strong>Time:</strong> {{ row[6].strftime('%H:%M') if row|length > 6 and row[6] else 'N/A' }}</p>
                                    <p><strong>User ID:</strong> {{ row[1] if row|length > 1 else 'N/A' }}</p>
                                    {% if row|length > 0 and row[0] and row|length > 1 and row[1] %}
                                    <form action="/resume_conversation/{{ row[0] }}" method="post">
                                        <input type="hidden" name="user_id" value="{{ row[1] }}">
                                        <button type="submit" class="resume-btn">Resume</button>
                                    </form>
                                    {% endif %}
                                </div>
                            </div>
                        {% endfor %}
                    {% else %}
                        <p style="text-align: center; color: #666; padding: 20px;">No users in agent queue.</p>
                    {% endif %}
                </div>
            </div>

            <!-- Analytics -->
            <div class="analytics">
                <div class="section-header">üìä Today's Analytics</div>
                <div class="analytics-grid">
                    <div class="analytics-card">
                        <div class="analytics-number" style="color: #dc3545;">{{ power_outage_count if power_outage_count is defined else 0 }}</div>
                        <div class="analytics-label">Power Outages</div>
                    </div>
                    <div class="analytics-card">
                        <div class="analytics-number" style="color: #ffc107;">{{ billing_count if billing_count is defined else 0 }}</div>
                        <div class="analytics-label">Billing Issues</div>
                    </div>
                    <div class="analytics-card">
                        <div class="analytics-number" style="color: #17a2b8;">{{ technical_count if technical_count is defined else 0 }}</div>
                        <div class="analytics-label">Technical Issues</div>
                    </div>
                    <div class="analytics-card">
                        <div class="analytics-number" style="color: #28a745;">{{ service_count if service_count is defined else 0 }}</div>
                        <div class="analytics-label">Service Requests</div>
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="complaintChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal -->
    <div class="modal" id="complaintModal">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="complaintModalLabel">Complaint Details</h5>
                    <button type="button" class="btn-close" onclick="closeModal()">&times;</button>
                </div>
                <div class="modal-body" id="complaintModalBody">
                    Loading...
                </div>
                <div class="modal-footer" id="complaintModalFooter">
                    <div>
                        <span id="currentStatus" style="font-weight: bold; color: #495057;"></span>
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <button type="button" class="btn btn-warning btn-sm" id="assignJobOrder" style="background: #ff9800; border-color: #ff9800;">Assign Job Order</button>
                        <button type="button" class="btn btn-primary btn-sm" id="updateStatusInProgress">Set In Progress</button>
                        <button type="button" class="btn btn-success btn-sm" id="updateStatusResolved">Mark Resolved</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Notification -->
    <div class="notification" id="notification">
        New complaint received!
    </div>

    <!-- JavaScript -->
    <script>
        // Global Variables
        let currentComplaintData = null;
        let currentComplaintFullData = null;
        let map;
        let markers = [];
        let complaintLocationData = [];

        // Document Ready Event
        document.addEventListener('DOMContentLoaded', function() {
            initializeEventListeners();
            initializeChart();
            initializeMap();
        });

        // Initialize Map
        function initializeMap() {
            map = L.map('map').setView([11.5854, 122.7507], 13);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors',
                maxZoom: 19
            }).addTo(map);

            const legend = L.control({ position: 'bottomright' });
            legend.onAdd = function() {
                const div = L.DomUtil.create('div', 'map-legend');
                div.innerHTML = `
                    <div class="legend-item">
                        <div class="legend-icon critical"></div>
                        <span>Critical Priority</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-icon high"></div>
                        <span>High Priority</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-icon medium"></div>
                        <span>Medium Priority</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-icon low"></div>
                        <span>Low Priority</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-icon resolved"></div>
                        <span>Resolved</span>
                    </div>
                `;
                return div;
            };
            legend.addTo(map);

            loadMapDataFromBackend();
        }

        // Load Map Data from Backend
        async function loadMapDataFromBackend() {
            try {
                const response = await fetch('/api/complaints_with_location');
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                complaintLocationData = await response.json();
                console.log(`Loaded ${complaintLocationData.length} complaints with location data`);
                
                updateMapMarkers();
                
            } catch (error) {
                console.error('Error loading map data:', error);
            }
        }

        // Update Map Markers
        function updateMapMarkers() {
            markers.forEach(marker => map.removeLayer(marker));
            markers = [];

            complaintLocationData.forEach(complaint => {
                if (!complaint.lat || !complaint.lng) return;
                
                const color = getMarkerColor(complaint.priority, complaint.status);
                
                const marker = L.circleMarker([complaint.lat, complaint.lng], {
                    radius: 10,
                    fillColor: color,
                    color: '#fff',
                    weight: 2,
                    opacity: 1,
                    fillOpacity: 0.8
                }).addTo(map);

                const popupContent = `
                    <div class="location-popup">
                        <h4>${complaint.customer || 'Unknown'}</h4>
                        <p><strong>Job Order:</strong> ${complaint.id || 'N/A'}</p>
                        <p><strong>Address:</strong> ${complaint.address || 'N/A'}</p>
                        <p><strong>Issue:</strong> ${complaint.issueType || 'N/A'}</p>
                        <p><strong>Contact:</strong> ${complaint.contact || 'N/A'}</p>
                        <p><strong>Priority:</strong> ${complaint.priority || 'N/A'}</p>
                        <span class="popup-status ${(complaint.status || '').toLowerCase()}">${complaint.status || 'N/A'}</span>
                    </div>
                `;

                marker.bindPopup(popupContent);
                markers.push(marker);
            });
        }

        // Get Marker Color
        function getMarkerColor(priority, status) {
            if (status && status.toLowerCase() === 'resolved') return '#2196f3';
            
            if (priority) {
                switch(priority.toUpperCase()) {
                    case 'CRITICAL': return '#b71c1c';
                    case 'HIGH': return '#f44336';
                    case 'MEDIUM': return '#ff9800';
                    case 'LOW': return '#4caf50';
                }
            }
            return '#9e9e9e';
        }

        // Search Location
        function searchLocation() {
            const address = document.getElementById('addressSearch').value;
            if (!address) {
                alert('Please enter an address to search');
                return;
            }
            
            const found = complaintLocationData.find(c => 
                c.address && c.address.toLowerCase().includes(address.toLowerCase())
            );
            
            if (found) {
                map.setView([found.lat, found.lng], 16);
                
                markers.forEach(marker => {
                    const markerLatLng = marker.getLatLng();
                    if (Math.abs(markerLatLng.lat - found.lat) < 0.0001 && 
                        Math.abs(markerLatLng.lng - found.lng) < 0.0001) {
                        marker.openPopup();
                    }
                });
            } else {
                alert('No complaints found at that address. Try a different search term.');
            }
        }

        // Refresh Map Data
        function refreshMapData() {
            loadMapDataFromBackend();
        }

        // Initialize Event Listeners
        function initializeEventListeners() {
            const viewButtons = document.querySelectorAll('.view-complaint');
            viewButtons.forEach(button => {
                button.addEventListener('click', handleViewComplaint);
            });

            const assignJobOrderBtn = document.getElementById('assignJobOrder');
            const inProgressBtn = document.getElementById('updateStatusInProgress');
            const resolvedBtn = document.getElementById('updateStatusResolved');

            if (assignJobOrderBtn) {
                assignJobOrderBtn.addEventListener('click', () => {
                    if (currentComplaintData && currentComplaintFullData) {
                        assignJobOrder(currentComplaintData.table, currentComplaintData.id, currentComplaintFullData);
                    }
                });
            }

            if (inProgressBtn) {
                inProgressBtn.addEventListener('click', () => {
                    if (currentComplaintData) {
                        updateStatus(currentComplaintData.table, currentComplaintData.id, 'IN_PROGRESS');
                    }
                });
            }

            if (resolvedBtn) {
                resolvedBtn.addEventListener('click', () => {
                    if (currentComplaintData) {
                        updateStatus(currentComplaintData.table, currentComplaintData.id, 'RESOLVED');
                    }
                });
            }

            window.addEventListener('click', function(event) {
                const modal = document.getElementById('complaintModal');
                if (event.target === modal) {
                    closeModal();
                }
            });
        }

        // Handle View Complaint Click
        async function handleViewComplaint(event) {
            const button = event.target;
            const table = button.getAttribute('data-table');
            const id = button.getAttribute('data-id');

            const modalTitle = document.getElementById('complaintModalLabel');
            const modalBody = document.getElementById('complaintModalBody');
            const modalFooter = document.getElementById('complaintModalFooter');

            modalTitle.textContent = 'Loading...';
            modalBody.innerHTML = '<p style="text-align: center; padding: 20px;">Loading complaint details...</p>';
            modalFooter.style.display = 'none';
            openModal();

            currentComplaintData = { table, id };

            try {
                const response = await fetch(`/view/${encodeURIComponent(table)}/${encodeURIComponent(id)}`);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const data = await response.json();

                modalTitle.textContent = data.title || 'Complaint Details';
                modalBody.innerHTML = '';
                currentComplaintFullData = data.details;

                if (data.details) {
                    for (const [key, value] of Object.entries(data.details)) {
                        const row = document.createElement('p');
                        row.innerHTML = `<strong>${key}:</strong> ${value || 'N/A'}`;
                        modalBody.appendChild(row);
                    }
                    
                    const currentStatusEl = document.getElementById('currentStatus');
                    const status = data.details.Status || data.details.status || 'NEW';
                    currentStatusEl.textContent = `Current Status: ${status}`;
                    
                    modalFooter.style.display = 'flex';
                    
                    const assignJobOrderBtn = document.getElementById('assignJobOrder');
                    const inProgressBtn = document.getElementById('updateStatusInProgress');
                    const resolvedBtn = document.getElementById('updateStatusResolved');
                    
                    assignJobOrderBtn.style.display = status === 'RESOLVED' ? 'none' : 'inline-block';
                    inProgressBtn.style.display = status === 'RESOLVED' ? 'none' : 'inline-block';
                    resolvedBtn.style.display = status === 'RESOLVED' ? 'none' : 'inline-block';
                } else {
                    modalBody.innerHTML = '<p style="text-align: center; color: #666;">No details available.</p>';
                }
            } catch (error) {
                console.error('Error loading complaint:', error);
                modalTitle.textContent = 'Error';
                modalBody.innerHTML = `<p style="text-align: center; color: #e74c3c;">Failed to load complaint data: ${error.message}</p>`;
            }
        }

        // Modal Functions
        function openModal() {
            document.getElementById('complaintModal').style.display = 'block';
            document.body.style.overflow = 'hidden';
        }

        function closeModal() {
            document.getElementById('complaintModal').style.display = 'none';
            document.body.style.overflow = 'auto';
        }

        // Assign Job Order Function
        async function assignJobOrder(table, recordId, complaintData) {
            if (!confirm('Are you sure you want to assign a job order for this complaint?')) return;
            
            try {
                const response = await fetch(`/assign_job_order/${encodeURIComponent(table)}/${encodeURIComponent(recordId)}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(complaintData)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showNotification(`Job Order assigned successfully! ID: ${data.converted_unique_id}`);
                    closeModal();
                    setTimeout(() => window.location.reload(), 2000);
                } else {
                    alert(`Error assigning job order: ${data.error || 'Unknown error'}`);
                }
            } catch (error) {
                console.error('Error assigning job order:', error);
                alert(`Error assigning job order: ${error.message}`);
            }
        }

        // Update Status Function
        async function updateStatus(table, recordId, status) {
            try {
                const response = await fetch(`/update_status/${encodeURIComponent(table)}/${encodeURIComponent(recordId)}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ status })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showNotification(`Status updated to ${status} successfully!`);
                    setTimeout(() => window.location.reload(), 1500);
                } else {
                    alert(`Error updating status: ${data.error || 'Unknown error'}`);
                }
            } catch (error) {
                console.error('Error updating status:', error);
                alert(`Error updating status: ${error.message}`);
            }
        }

        // Remove Complaint Function
        function removeComplaint(table, recordId) {
            if (!confirm("Are you sure you want to remove this complaint?")) {
                return;
            }

            fetch(`/delete_complaint/${table}/${recordId}`, {
                method: "POST"
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const row = document.querySelector(
                        `button[onclick="removeComplaint('${table}', '${recordId}')"]`
                    ).closest("tr");
                    row.remove();
                    showNotification('Complaint removed successfully');
                } else {
                    alert("Error: " + data.error);
                }
            })
            .catch(error => {
                alert("Request failed: " + error);
            });
        }

        // Quick Filter Functions
        function setQuickFilter(period) {
            const today = new Date();
            const dateFrom = document.getElementById('date_from');
            const dateTo = document.getElementById('date_to');
            const timeFrom = document.getElementById('time_from');
            const timeTo = document.getElementById('time_to');
            
            document.querySelectorAll('.quick-filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            event.target.classList.add('active');
            
            switch(period) {
                case 'today':
                    dateFrom.value = today.toISOString().split('T')[0];
                    dateTo.value = today.toISOString().split('T')[0];
                    timeFrom.value = '00:00';
                    timeTo.value = '23:59';
                    break;
                case 'yesterday':
                    const yesterday = new Date(today);
                    yesterday.setDate(yesterday.getDate() - 1);
                    dateFrom.value = yesterday.toISOString().split('T')[0];
                    dateTo.value = yesterday.toISOString().split('T')[0];
                    timeFrom.value = '00:00';
                    timeTo.value = '23:59';
                    break;
                case 'week':
                    const weekStart = new Date(today);
                    weekStart.setDate(today.getDate() - today.getDay());
                    dateFrom.value = weekStart.toISOString().split('T')[0];
                    dateTo.value = today.toISOString().split('T')[0];
                    timeFrom.value = '00:00';
                    timeTo.value = '23:59';
                    break;
                case 'month':
                    const monthStart = new Date(today.getFullYear(), today.getMonth(), 1);
                    dateFrom.value = monthStart.toISOString().split('T')[0];
                    dateTo.value = today.toISOString().split('T')[0];
                    timeFrom.value = '00:00';
                    timeTo.value = '23:59';
                    break;
            }
            
            document.getElementById('filterForm').submit();
        }
        
        // Clear All Filters Function
        function clearAllFilters() {
            document.getElementById('search').value = '';
            document.getElementById('status').value = 'All Status';
            document.getElementById('priority').value = 'All Priorities';
            document.getElementById('type').value = 'All Types';
            document.getElementById('date_from').value = '';
            document.getElementById('date_to').value = '';
            document.getElementById('time_from').value = '';
            document.getElementById('time_to').value = '';
            
            document.querySelectorAll('.quick-filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            document.getElementById('filterForm').submit();
        }

        // Show Notification Function
        function showNotification(message) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.classList.add('show');
            
            setTimeout(() => notification.classList.remove('show'), 3000);
        }

        // Chart Initialization
        function initializeChart() {
            const ctx = document.getElementById('complaintChart');
            if (!ctx) return;

            try {
                const powerOutageCount = parseInt('{{ power_outage_count if power_outage_count is defined else 0 }}') || 0;
                const billingCount = parseInt('{{ billing_count if billing_count is defined else 0 }}') || 0;
                const technicalCount = parseInt('{{ technical_count if technical_count is defined else 0 }}') || 0;
                const serviceCount = parseInt('{{ service_count if service_count is defined else 0 }}') || 0;
                
                const chartData = [powerOutageCount, billingCount, technicalCount, serviceCount];
                
                new Chart(ctx.getContext('2d'), {
                    data: {
                        labels: ['Power Outage', 'Billing', 'Technical', 'Service'],
                        datasets: [{
                            data: chartData,
                            backgroundColor: ['#dc3545', '#ffc107', '#17a2b8', '#28a745'],
                            borderWidth: 2,
                            borderColor: '#fff'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    padding: 15,
                                    usePointStyle: true,
                                    font: { size: 11 }
                                }
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('Chart initialization error:', error);
            }
        }
    </script>   
</body>
</html>
